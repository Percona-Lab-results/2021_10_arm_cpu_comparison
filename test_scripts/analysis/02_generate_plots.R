library(readr)
library(jsonlite)
library(data.table)
library(tidyverse)
library(ggplot2)
library(rjson)
library(rlist)
library(future)
library(furrr)
library(parallel)
library(foreach)
library(doParallel)
library(tictoc)
library(plotly)
require(magick)
require(cowplot)
source("00_functions.R")
source("00_viz_functions.R")

tic("picture generation took")
print("==============================================================")
back_up_wd <- getwd()
curent_dir <- system("pwd",intern = TRUE)
path_to_save_plots <- paste(curent_dir, "/autogen_plots", sep="")
dir.create(path_to_save_plots)
setwd(path_to_save_plots)
print(curent_dir)
print("==============================================================")

oltp_test_result <- fst::read.fst(path_to_file) %>% as.data.table()

col_list <- c("read" ,"query_exec_other",
              "query_exec_general_statistic_total_number_of_events","latency_ms_min", "latency_ms_avg", "latency_ms_max",
              "latency_ms_95th_percentile", "latency_ms_sum", "latency_ms_events_avg", "latency_ms_events_stddev",
              "latency_ms_execution_time_avg","latency_ms_execution_time_stddev", "sql_stat_transactions_total",
              "sql_stat_transactions_per_sec","queries_total", "queries_per_sec" )




cpuList <- oltp_test_result$cpu_amount %>% unique()
ec2_types <- oltp_test_result$ec2_type %>% unique()

for(column in col_list){

  print(column)
  autogenerated_title <- paste(column,"autogenerated", sep = "_")
  print(autogenerated_title)
  auto_plot <- get_db_universal(oltp_test_result,
                           input_title = autogenerated_title,
                           column_name = column,
                           yaxis_label = column,
                           input_subtitle = "",
                           input_caption = "sysbench: 1.0.18, MySQL: 8.0.26-0",
                           x_axis_aws = FALSE,
                           add_logo = TRUE,
                           facet_cpu=TRUE)
  save_plot(autogenerated_title, auto_plot)

  for(cpu_num in cpuList){
    autogenerated_title <- paste(column, "for", cpu_num,"cpu","autogenerated", sep = "_")
    print(autogenerated_title)
    auto_plot <- get_db_universal(oltp_test_result[cpu_amount == cpu_num],
                                  input_title = autogenerated_title,
                                  column_name = column,
                                  yaxis_label = column,
                                  input_subtitle = "",
                                  input_caption = "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                  x_axis_aws = FALSE,
                                  add_logo = TRUE,
                                  facet_cpu=TRUE)
    save_plot(autogenerated_title, auto_plot)
  }

  for(ec2 in ec2_types){
    autogenerated_title <- paste(column, "for",ec2,"autogenerated", sep = "_")
    print(autogenerated_title)
    auto_plot <- get_db_universal(oltp_test_result[ec2_type == ec2],
                                  input_title = autogenerated_title,
                                  column_name = column,
                                  yaxis_label = column,
                                  input_subtitle = "",
                                  input_caption = "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                  x_axis_aws = FALSE,
                                  add_logo = TRUE,
                                  facet_cpu=TRUE)
    save_plot(autogenerated_title, auto_plot)
  }
}



### relative comparison #########
rel_com_overview <- intel_graviton_comparison(oltp_test_result,
                                              input_subtitle="",
                                              input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                              input_relative=TRUE)
save_plot("03_rel_com_overview.png", rel_com_overview)

rel_com_s <- intel_graviton_comparison(oltp_test_result[ec2_type == "slow"],
                                       input_subtitle="",
                                       input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                       input_relative=TRUE)
save_plot("03_rel_com_s.png", rel_com_s)

rel_com_m <- intel_graviton_comparison(oltp_test_result[ec2_type == "medium"],
                                       input_subtitle="",
                                       input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                       input_relative=TRUE)
save_plot("03_rel_com_m.png", rel_com_m)

rel_com_f <- intel_graviton_comparison(oltp_test_result[ec2_type == "fast"],
                                       input_subtitle="",
                                       input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                       input_relative=TRUE)
save_plot("03_rel_com_f.png", rel_com_f)

### absolute comparison ##########
abs_com_overview <- intel_graviton_comparison(oltp_test_result,
                                              input_subtitle="",
                                              input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                              input_relative=FALSE)
save_plot("04_abs_com_overview.png", abs_com_overview)

abs_com_s <- intel_graviton_comparison(oltp_test_result[ec2_type == "small"],
                                       input_subtitle="",
                                       input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                       input_relative=FALSE)
save_plot("04_abs_com_s.png", abs_com_s)

abs_com_m <- intel_graviton_comparison(oltp_test_result[ec2_type == "medium"],
                                       input_subtitle="",
                                       input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                       input_relative=FALSE)
save_plot("04_abs_com_m.png", abs_com_m)

abs_com_f <- intel_graviton_comparison(oltp_test_result[ec2_type == "large"],
                                       input_subtitle="",
                                       input_caption= "sysbench: 1.0.18, MySQL: 8.0.26-0",
                                       input_relative=FALSE)
save_plot("04_abs_com_f.png", abs_com_f)




### requests per_dollar ###########
p_05_rpd_overview <- requests_per_dollar(oltp_test_result)
save_plot("05_p_05_rpd_overview.png", p_05_rpd_overview)
p_05_rpd_s <- requests_per_dollar(oltp_test_result[ec2_type == "small"])
save_plot("05_p_05_rpd_s.png", p_05_rpd_s)
p_05_rpd_m <- requests_per_dollar(oltp_test_result[ec2_type == "medium"])
save_plot("05_p_05_rpd_m.png", p_05_rpd_m)
p_05_rpd_f <- requests_per_dollar(oltp_test_result[ec2_type != "small"])
save_plot("05_p_05_rpd_l.png", p_05_rpd_f)

### request per hour  ##############
p_06_rph_overview <- requests_ph(oltp_test_result)
save_plot("06_p_06_rph_overview.png", p_06_rph_overview)
p_06_rph_s <- requests_ph(oltp_test_result[ec2_type == "small"])
save_plot("06_p_06_rph_s.png", p_06_rph_s)
p_06_rph_m <- requests_ph(oltp_test_result[ec2_type == "medium"])
save_plot("06_p_06_rph_m.png", p_06_rph_m)
p_06_rph_f <- requests_ph(oltp_test_result[ec2_type != "small"])
save_plot("06_p_06_rph_l.png", p_06_rph_f)

#### eficient
p_07_efficiency_overview <- efficient_comparison_point_plot(oltp_test_result, facet_threads=FALSE)
# print(p_10_overview)
save_plot("07_p_07_efficiency_overview.png", p_07_efficiency_overview)

toc()
